---
output: 
  html_document:
    includes:
      in_header: google-analytics.html
title: "Seagrass coverage estimates"
css: styles.css
runtime: shiny
---

# {.tabset}

This application provides a summary of seagrass areal coverage estimates for Tampa Bay, by [major bay segments](https://drive.google.com/file/d/1DIyZ_gH48t_gLSQGd23sAW-3AhAtoASZ/view?usp=sharing) and [seagrass management areas](https://drive.google.com/file/d/1mFRte9yfk9hV-tYRtdcwW7JpGgXmvHHX/view?usp=sharing).  Coverage estimates are provided for each year of available coverage data from the Southwest Florida Water Management District, published approximately biennially since the 1980s (available [here](https://data-swfwmd.opendata.arcgis.com/search?groupIds=d9a4213eb9ea4713bb710e03bdcc6648)). Historical coverages for 1950 and 1982 are only available for the continuous + patchy segment tab. Note that the nominal year for each layer provides a snapshot estimate of coverage from aerial photos taken at the end of the growing season for the year prior.  For example, the 2020 layer was based on images obtained in December 2019.  All estimates are provided in acres.  

The Tampa Bay tab provides a summary for the entire bay using historical estimates for past years.  The segment and management area tabs provide coverage summaries specific to the relevant boundaries in each tab. Comparisons between years can be made for the segment and management area tabs by selecting year pairs from the slider.  Changes in coverage between the selected years are shown on the far right columns of each table and as differences in the maps. 

<a rel='license' href='http://creativecommons.org/licenses/by/4.0/'><img alt='Creative Commons License' style='border-width:0' src='https://i.creativecommons.org/l/by/4.0/88x31.png' /></a>&nbsp;&nbsp;This application is licensed under a <a rel='license' href='http://creativecommons.org/licenses/by/4.0/'>Creative Commons Attribution 4.0 International License</a>. Please contact [Marcus Beck](mailto:mbeck@tbep.org) for more information. Source code is available [here](https://github.com/tbep-tech/seagrass-analysis).

[![DOI](https://zenodo.org/badge/402824973.svg)](https://zenodo.org/badge/latestdoi/402824973)

```{r setup, message = F, warning = F, results = 'hide', echo = F}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, echo = F, fig.path = 'figs/', fig.path = 'figures/')
box::use(
  here[...], 
  dplyr[...],
  shiny[...], 
  shinyWidgets[sliderTextInput],
  leaflet[renderLeaflet, leafletOutput],
  tidyr[spread, gather],
  reactable[reactableOutput, renderReactable], 
  knitr[include_graphics, kable], 
  R/funcs[sgrctfun, sgmapfun, sgchgfun]
)
data(file = 'seagrass', package = 'tbeptools')
data(file = 'sgseg', package = 'tbeptools')
data(file = 'sgmanagement', package = 'tbeptools')
load(file = here('data/allsegests.RData'))
load(file = here('data/allmngests.RData'))

# years to select
yrs <- unique(allsegests$yr) %>% 
  sort %>% 
  .[1:(length(.))] %>% 
  c('1950', '1982', .)

# combined segment estimates
segcmbests <- allsegests %>% 
  filter(Habitat %in% c('patchy', 'cont.')) %>% 
  group_by(yr, Segment) %>% 
  summarise(
    Acres = sum(Acres, na.rm = T), 
    .groups = 'drop'
    ) %>% 
  spread(yr, Acres, fill = 0)
segcmbhst <- tibble(
    Segment = c("Boca Ciega Bay", "Hillsborough Bay", "Lower Tampa Bay", "Manatee River", 
                "Middle Tampa Bay", "Old Tampa Bay", "Terra Ceia Bay"),
    `1950` = c(10800, 2300, 6100, 200, 9600, 10700, 700), 
    `1982` = c(5770, 0, 5016, 131, 4042, 5943, 751)
  )
segcmbests <- segcmbhst %>% 
  full_join(segcmbests, by = 'Segment')

# patchy segment estimates
segptcests <- allsegests %>% 
  filter(Habitat == 'patchy') %>% 
  select(yr, Segment, Acres) %>% 
  spread(yr, Acres, fill = 0)

# continuous segment estimates
segcntests <- allsegests %>% 
  filter(Habitat == 'cont.') %>% 
  select(yr, Segment, Acres) %>% 
  spread(yr, Acres, fill = 0)

# combined management estimates
mngcmbests <- allmngests %>% 
  filter(Habitat %in% c('patchy', 'cont.')) %>% 
  group_by(yr, Areas) %>% 
  summarise(
    Acres = sum(Acres, na.rm = T), 
    .groups = 'drop'
    ) %>% 
  spread(yr, Acres, fill = 0)

# patchy management estimates
mngptcests <- allmngests %>% 
  filter(Habitat == 'patchy') %>% 
  select(yr, Areas, Acres) %>% 
  spread(yr, Acres, fill = 0)

# continuous management estimates
mngcntests <- allmngests %>% 
  filter(Habitat == 'cont.') %>% 
  select(yr, Areas, Acres) %>% 
  spread(yr, Acres, fill = 0)

# max segment diff
segmaxv <- segcmbests %>% 
  gather('var', 'val', -Segment) %>% 
  group_by(Segment) %>% 
  summarise(
    maxv = max(val, na.rm = T), 
    minv = min(val, na.rm = T)
  ) %>% 
  mutate(
    rng = maxv - minv
  ) %>% 
  pull(rng) %>% 
  max

# max management diff
mngmaxv <- mngcmbests %>% 
  gather('var', 'val', -Areas) %>% 
  group_by(Areas) %>% 
  summarise(
    maxv = max(val, na.rm = T), 
    minv = min(val, na.rm = T)
  ) %>% 
  mutate(
    rng = maxv - minv
  ) %>% 
  pull(rng) %>% 
  max

# leaflet height
lfht <- 600
```

```{r reactives}
# segment combined trend table
segcmbtab <- reactive({
  
  # inputs
  yrsel1 <- input$yrsel1
  out <- sgrctfun(segcmbests, 'Segment', yrsel = yrsel1)

  return(out)
  
})

# segment combined map
segcmbmap <- reactive({
  
  # inputs
  yrsel1 <- input$yrsel1
  out <- sgmapfun(segcmbests, 'Segment', yrsel = yrsel1, bndin = sgseg, maxv = segmaxv)

  return(out)
  
})

# segment cont trend table
segcnttab <- reactive({
  
  # inputs
  yrsel1 <- input$yrsel1
  out <- sgrctfun(segcntests, 'Segment', yrsel = yrsel1)

  return(out)
  
})

# segment cont map
segcntmap <- reactive({
  
  # inputs
  yrsel1 <- input$yrsel1
  out <- sgmapfun(segcntests, 'Segment', yrsel = yrsel1, bndin = sgseg, maxv = segmaxv)

  return(out)
  
})

# segment patchy trend table
segptctab <- reactive({
  
  # inputs
  yrsel1 <- input$yrsel1
  out <- sgrctfun(segptcests, 'Segment', yrsel = yrsel1)

  return(out)
  
})

# segment patchy map
segptcmap <- reactive({
  
  # inputs
  yrsel1 <- input$yrsel1
  out <- sgmapfun(segptcests, 'Segment', yrsel = yrsel1, bndin = sgseg, maxv = segmaxv)

  return(out)
  
})

# management area combined trend table
mngcmbtab <- reactive({
  
  # inputs
  yrsel2 <- input$yrsel2
  out <- sgrctfun(mngcmbests, 'Areas', yrsel = yrsel2)

  return(out)
  
})

# management area combined map
mngcmbmap <- reactive({
  
  # inputs
  yrsel2 <- input$yrsel2
  out <- sgmapfun(mngcmbests, 'Areas', yrsel = yrsel2, bndin = sgmanagement, maxv = mngmaxv)

  return(out)
  
})

# management area cont trend table
mngcnttab <- reactive({
  
  # inputs
  yrsel2 <- input$yrsel2
  out <- sgrctfun(mngcntests, 'Areas', yrsel = yrsel2)

  return(out)
  
})

# management area cont map
mngcntmap <- reactive({
  
  # inputs
  yrsel2 <- input$yrsel2
  out <- sgmapfun(mngcntests, 'Areas', yrsel = yrsel2, bndin = sgmanagement, maxv = mngmaxv)

  return(out)
  
})

# management area patchy trend table
mngptctab <- reactive({
  
  # inputs
  yrsel2 <- input$yrsel2
  out <- sgrctfun(mngptcests, 'Areas', yrsel = yrsel2)

  return(out)
  
})

# management area patchy map
mngptcmap <- reactive({
  
  # inputs
  yrsel2 <- input$yrsel2
  out <- sgmapfun(mngptcests, 'Areas', yrsel = yrsel2, bndin = sgmanagement, maxv = mngmaxv)

  return(out)
  
})
```

## Tampa Bay

```{r}
kable(seagrass, caption = 'All estimates for all segments, based on historical coverages used to report on annual progress toward recovery goals.', digits = 0)
```

[download figure](https://github.com/tbep-tech/seagrass-analysis/raw/main/figures/seagrasscov.png){target="_blank"}

```{r, out.width = '100%'}
include_graphics('figures/seagrasscov.png')
```

## By segment {.tabset .tabset-pills}

```{r}
sliderTextInput('yrsel1', 'Select year comparison', choices = yrs, grid = T, width = '600px', selected = c(yrs[1], rev(yrs)[1]))
```

### Continous + Patchy

```{r}
output$segcmbtab <- renderReactable(segcmbtab())
reactableOutput('segcmbtab')
```

```{r}
output$segcmbmap <- renderLeaflet(segcmbmap())
leafletOutput('segcmbmap', height = lfht)
```

### Continuous

```{r}
output$segcnttab <- renderReactable(segcnttab())
reactableOutput('segcnttab')
```

```{r}
output$segcntmap <- renderLeaflet(segcntmap())
leafletOutput('segcntmap', height = lfht)
```

### Patchy

```{r}
output$segptctab <- renderReactable(segptctab())
reactableOutput('segptctab')
```

```{r}
output$segptcmap <- renderLeaflet(segptcmap())
leafletOutput('segptcmap', height = lfht)
```

## By management area {.tabset .tabset-pills}

```{r}
sliderTextInput('yrsel2', 'Select year comparison', choices = yrs, grid = T, width = '600px', selected = c(yrs[1], rev(yrs)[1]))
```

### Continous + Patchy

```{r}
output$mngcmbtab <- renderReactable(mngcmbtab())
reactableOutput('mngcmbtab')
```

```{r}
output$mngcmbmap <- renderLeaflet(mngcmbmap())
leafletOutput('mngcmbmap', height = lfht)
```

### Continuous

```{r}
output$mngcnttab <- renderReactable(mngcnttab())
reactableOutput('mngcnttab')
```

```{r}
output$mngcntmap <- renderLeaflet(mngcntmap())
leafletOutput('mngcntmap', height = lfht)
```

### Patchy

```{r}
output$mngptctab <- renderReactable(mngptctab())
reactableOutput('mngptctab')
```

```{r}
output$mngptcmap <- renderLeaflet(mngptcmap())
leafletOutput('mngptcmap', height = lfht)
```
