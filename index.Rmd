---
output: 
  html_document
title: "Seagrass coverage estimates"
css: styles.css
runtime: shiny
---

# {.tabset .tabset-pills}

Source code here: https://github.com/tbep-tech/seagrass-analysis

```{r setup, message = F, warning = F, results = 'hide', echo = F}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, echo = F, fig.path = 'figs/', fig.path = 'figures/')
box::use(
  here[...], 
  dplyr[...],
  shiny[...], 
  tidyr[spread, gather],
  downloadthis[download_this],
  reactable[reactableOutput, renderReactable], 
  knitr[include_graphics, kable], 
  R/funcs[sgrctfun]
)
data(file = 'seagrass', package = 'tbeptools')
data(file = 'sgseg', package = 'tbeptools')
load(file = here('data/allsegests.RData'))
load(file = here('data/allmngests.RData'))

# years to select
yrs <- unique(allsegests$yr) %>% 
  sort %>% 
  .[1:(length(.) - 1)]

# combined segment estimates
segcmbests <- allsegests %>% 
  filter(Habitat %in% c('patchy', 'cont.')) %>% 
  group_by(yr, Segment) %>% 
  summarise(
    Acres = sum(Acres, na.rm = T), 
    .groups = 'drop'
    ) %>% 
  spread(yr, Acres, fill = 0)

# patchy segment estimates
segptcests <- allsegests %>% 
  filter(Habitat == 'patchy') %>% 
  select(yr, Segment, Acres) %>% 
  spread(yr, Acres, fill = 0)

# continuous segment estimates
segcntests <- allsegests %>% 
  filter(Habitat == 'cont.') %>% 
  select(yr, Segment, Acres) %>% 
  spread(yr, Acres, fill = 0)

# combined management estimates
mngcmbests <- allmngests %>% 
  filter(Habitat %in% c('patchy', 'cont.')) %>% 
  group_by(yr, Areas) %>% 
  summarise(
    Acres = sum(Acres, na.rm = T), 
    .groups = 'drop'
    ) %>% 
  spread(yr, Acres, fill = 0)

# patchy segment estimates
mngptcests <- allmngests %>% 
  filter(Habitat == 'patchy') %>% 
  select(yr, Areas, Acres) %>% 
  spread(yr, Acres, fill = 0)

# continuous segment estimates
mngcntests <- allmngests %>% 
  filter(Habitat == 'cont.') %>% 
  select(yr, Areas, Acres) %>% 
  spread(yr, Acres, fill = 0)
```

```{r reactives}
# segment combined trend table
segcmbtab <- reactive({
  
  # inputs
  yrsel1 <- input$yrsel1
  out <- sgrctfun(segcmbests, 'Segment', yrsel = yrsel1)

  return(out)
  
})

# segment cont trend table
segcnttab <- reactive({
  
  # inputs
  yrsel1 <- input$yrsel1
  out <- sgrctfun(segcntests, 'Segment', yrsel = yrsel1)

  return(out)
  
})

# segment patchy trend table
segptctab <- reactive({
  
  # inputs
  yrsel1 <- input$yrsel1
  out <- sgrctfun(segptcests, 'Segment', yrsel = yrsel1)

  return(out)
  
})

# management area combined trend table
mngcmbtab <- reactive({
  
  # inputs
  yrsel2 <- input$yrsel2
  out <- sgrctfun(mngcmbests, 'Areas', yrsel = yrsel2)

  return(out)
  
})

# management area cont trend table
mngcnttab <- reactive({
  
  # inputs
  yrsel2 <- input$yrsel2
  out <- sgrctfun(mngcntests, 'Areas', yrsel = yrsel2)

  return(out)
  
})

# management area patchy trend table
mngptctab <- reactive({
  
  # inputs
  yrsel2 <- input$yrsel2
  out <- sgrctfun(mngptcests, 'Areas', yrsel = yrsel2)

  return(out)
  
})
```

## Tampa Bay

```{r}
download_this(seagrass, 
  output_name = "sgests-all",
  output_extension = ".xlsx",
  button_label = "Download data",
  button_type = "warning",
  has_icon = TRUE,
  icon = "fa fa-save" 
  )

kable(seagrass, caption = 'All estimates for all segments, based on historical coverages used to report on annual progress toward recovery goals.', digits = 0)
```

[download figure](figures/seagrasscov.png)

```{r, out.width = '100%'}
include_graphics('figures/seagrasscov.png')
```

## By segment {.tabset}

```{r}
selectInput('yrsel1', 'Select year comparison', choices = yrs, selected = yrs[1])
```

##### `r renderText(input$yrsel1)` to 2020 change {.tabset .tabset-pills} 


### Continous + Patchy

```{r}
output$segcmbtab <- renderReactable(segcmbtab())
reactableOutput('segcmbtab')
```

### Continuous

```{r}
output$segcnttab <- renderReactable(segcnttab())
reactableOutput('segcnttab')
```

### Patchy

```{r}
output$segptctab <- renderReactable(segptctab())
reactableOutput('segptctab')
```

## By management area {.tabset}

```{r}
selectInput('yrsel2', 'Select year comparison', choices = yrs, selected = yrs[1])
```

##### `r renderText(input$yrsel2)` to 2020 change {.tabset .tabset-pills} 

### Continous + Patchy

```{r}
output$mngcmbtab <- renderReactable(mngcmbtab())
reactableOutput('mngcmbtab')
```

### Continuous

```{r}
output$mngcnttab <- renderReactable(mngcnttab())
reactableOutput('mngcnttab')
```

### Patchy

```{r}
output$mngptctab <- renderReactable(mngptctab())
reactableOutput('mngptctab')
```
